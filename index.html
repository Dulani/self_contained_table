<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 300px;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
        }
        .main-content {
            flex: 1;
            padding: 20px;
        }
        .filter-section {
            margin-bottom: 25px;
        }
        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #212529;
            font-size: 1.1em;
        }
        .year-range {
            margin-bottom: 15px;
        }
        .year-range {
            position: relative;
            height: 40px;
            padding: 0 10px;
        }
        .year-slider {
            position: relative;
            width: 100%;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 20px 0;
        }
        .year-slider .track {
            position: absolute;
            height: 100%;
            background: #007bff;
            border-radius: 2px;
        }
        .year-slider .handle {
            position: absolute;
            width: 18px;
            height: 18px;
            background: #007bff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 2;
        }
        .year-slider .handle:hover {
            background: #0056b3;
        }
        .year-display {
            font-size: 0.9em;
            color: #6c757d;
            text-align: center;
            margin: 5px 0;
        }
        .year-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            color: #6c757d;
            font-size: 0.8em;
        }
        .checkbox-group {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }
        .checkbox-item {
            margin-bottom: 8px;
        }
        .checkbox-item label {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: #495057;
            cursor: pointer;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-subgroup {
            margin-left: 24px;
            margin-top: 4px;
        }
        .checkbox-subgroup .checkbox-item {
            margin-bottom: 4px;
        }
        .law-class-toggle {
            cursor: pointer;
            user-select: none;
            margin-left: 4px;
        }
        .law-class-toggle::before {
            content: '▼';
            display: inline-block;
            margin-right: 4px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        .law-class-toggle.collapsed::before {
            transform: rotate(-90deg);
        }
        .clear-filters {
            width: 100%;
            padding: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }
        .clear-filters:hover {
            background-color: #5a6268;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #f2f2f2;
        }
        .download-btn {
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .download-btn:hover {
            background-color: #218838;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        .search-box {
            flex: 1;
        }
        .search-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pagination-controls select {
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
        }
        .pagination-controls button {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-controls span {
            color: #6c757d;
        }
        th {
            cursor: pointer;
            user-select: none;
        }
        th::after {
            content: '↕';
            margin-left: 5px;
            opacity: 0.3;
        }
        th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }
        th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="filter-section">
            <h3>Year Range</h3>
            <div class="year-range">
                <div class="year-slider" id="yearSlider">
                    <div class="track"></div>
                    <div class="handle" id="startHandle"></div>
                    <div class="handle" id="endHandle"></div>
                </div>
                <div class="year-display" id="yearDisplay">1979 - 2023</div>
                <div class="year-labels">
                    <span>1979</span>
                    <span>2023</span>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h3>Filter by Law Class</h3>
            <div class="checkbox-group" id="lawClassFilters">
                <!-- Law class checkboxes will be dynamically added here -->
            </div>
        </div>

        <button class="clear-filters" id="clearFilters">Clear Filters</button>
    </div>

    <div class="main-content">
        <div class="table-controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search across all columns...">
            </div>
            <div class="pagination-controls">
                <select id="entriesPerPage">
                    <option value="5">5 per page</option>
                    <option value="10" selected>10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
                <button id="prevPage" disabled>Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextPage" disabled>Next</button>
            </div>
            <button class="download-btn" id="downloadData">Download Data</button>
        </div>
        <table id="dataTable">
        <thead>
            <tr>
                <!-- Table headers will be dynamically populated -->
            </tr>
        </thead>
        <tbody>
            <!-- Table data will be dynamically populated -->
        </tbody>
    </table>

    <script>
        // Embedded data
        const tableData = [
            {
                "state": "California",
                "state_abb": "CA",
                "fips": "06",
                "year": 1985,
                "year_frac": 1985.0,
                "law_class": "Background Checks",
                "law_class_subtype": "Private Sales",
                "handguns_or_long_guns": "Handguns"
            },
            {
                "state": "California",
                "state_abb": "CA",
                "fips": "06",
                "year": 1990,
                "year_frac": 1990.0,
                "law_class": "CCW",
                "law_class_subtype": "Shall Issue",
                "handguns_or_long_guns": "Handguns"
            },
            {
                "state": "Texas",
                "state_abb": "TX",
                "fips": "48",
                "year": 1995,
                "year_frac": 1995.0,
                "law_class": "Background Checks",
                "law_class_subtype": "Dealer Sales",
                "handguns_or_long_guns": "All"
            },
            {
                "state": "New York",
                "state_abb": "NY",
                "fips": "36",
                "year": 2000,
                "year_frac": 2000.0,
                "law_class": "Assault Weapons",
                "law_class_subtype": "Ban",
                "handguns_or_long_guns": "Long Guns"
            },
            {
                "state": "Florida",
                "state_abb": "FL",
                "fips": "12",
                "year": 2005,
                "year_frac": 2005.0,
                "law_class": "Stand Your Ground",
                "law_class_subtype": "Castle Doctrine",
                "handguns_or_long_guns": "All"
            }
        ];
        let filteredData = [...tableData];

        // Global variables
        const minYear = 1979;
        const maxYear = 2023;
        let startYear = minYear;
        let endYear = maxYear;
        
        // Global variables for pagination
        let currentPage = 1;
        let rowsPerPage = 10;
        let currentSortColumn = null;
        let isAscending = true;

        // Function to apply search filter
        function applySearchFilter(data, searchTerm) {
            if (!searchTerm) return data;
            searchTerm = searchTerm.toLowerCase();
            return data.filter(row => 
                Object.values(row).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                )
            );
        }

        // Function to apply year range filter
        function applyYearFilter(data, yearStart, yearEnd) {
            return data.filter(row => 
                parseInt(row.year) >= yearStart && 
                parseInt(row.year) <= yearEnd
            );
        }

        // Function to apply law class and subtype filter
        function applyLawFilter(data, selectedFilters) {
            return data.filter(row =>
                selectedFilters.some(filter => 
                    filter.lawClass === row.law_class && 
                    filter.subtype === row.law_class_subtype
                )
            );
        }
        // Function to sort data
        function sortData(data, column) {
            return [...data].sort((a, b) => {
                const aVal = a[column];
                const bVal = b[column];
                
                if (typeof aVal === 'number') {
                    return isAscending ? aVal - bVal : bVal - aVal;
                }
                
                return isAscending 
                    ? aVal.toString().localeCompare(bVal.toString())
                    : bVal.toString().localeCompare(aVal.toString());
            });
        }

        // Function to handle pagination
        function paginate(data) {
            const startIndex = (currentPage - 1) * rowsPerPage;
            return data.slice(startIndex, startIndex + rowsPerPage);
        }

        // Function to update pagination controls
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        }

        // Initialize the table and controls
        function initialize() {
            renderTable();
            setupControls();
        }

        // Function to render the table
        function renderTable() {
            const thead = document.querySelector('#dataTable thead tr');
            const tbody = document.querySelector('#dataTable tbody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // If we have data, render the table
            if (filteredData.length > 0) {
                // Add headers with sort functionality
                Object.keys(filteredData[0]).forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    th.addEventListener('click', () => {
                        if (currentSortColumn === key) {
                            isAscending = !isAscending;
                        } else {
                            currentSortColumn = key;
                            isAscending = true;
                        }
                        
                        // Remove sort classes from all headers
                        thead.querySelectorAll('th').forEach(header => {
                            header.classList.remove('sort-asc', 'sort-desc');
                        });
                        
                        // Add sort class to current header
                        th.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
                        
                        // Sort and render
                        filteredData = sortData(filteredData, key);
                        renderTable();
                    });
                    
                    if (currentSortColumn === key) {
                        th.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
                    }
                    
                    thead.appendChild(th);
                });

                // Get paginated data
                const paginatedData = paginate(filteredData);

                // Add data rows
                paginatedData.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(value => {
                        tr.innerHTML += `<td>${value}</td>`;
                    });
                    tbody.appendChild(tr);
                });
            }
        }

        // Function to setup interactive controls
        function setupControls() {
            if (tableData.length > 0) {
                // Setup year range slider
                const yearSlider = document.getElementById('yearSlider');
                const startHandle = document.getElementById('startHandle');
                const endHandle = document.getElementById('endHandle');
                const track = yearSlider.querySelector('.track');
                const yearDisplay = document.getElementById('yearDisplay');
                
                const range = maxYear - minYear;
                let activeHandle = null;
                
                // Initialize handle positions
                function updateHandlePositions() {
                    const startPos = ((startYear - minYear) / range) * 100;
                    const endPos = ((endYear - minYear) / range) * 100;
                    startHandle.style.left = startPos + '%';
                    endHandle.style.left = endPos + '%';
                    track.style.left = startPos + '%';
                    track.style.width = (endPos - startPos) + '%';
                    yearDisplay.textContent = `${startYear} - ${endYear}`;
                }
                
                // Convert position to year
                function positionToYear(position) {
                    const rect = yearSlider.getBoundingClientRect();
                    const percent = Math.max(0, Math.min(1, (position - rect.left) / rect.width));
                    return Math.round(minYear + percent * range);
                }
                
                // Handle mouse events
                yearSlider.addEventListener('mousedown', function(e) {
                    const startPos = ((startYear - minYear) / range) * yearSlider.offsetWidth;
                    const endPos = ((endYear - minYear) / range) * yearSlider.offsetWidth;
                    const clickPos = e.clientX - yearSlider.getBoundingClientRect().left;
                    
                    // Determine which handle to drag based on closest distance
                    if (Math.abs(clickPos - startPos) < Math.abs(clickPos - endPos)) {
                        activeHandle = startHandle;
                    } else {
                        activeHandle = endHandle;
                    }
                    
                    document.addEventListener('mousemove', handleDrag);
                    document.addEventListener('mouseup', stopDrag);
                });
                
                function handleDrag(e) {
                    if (!activeHandle) return;
                    
                    const year = positionToYear(e.clientX);
                    
                    if (activeHandle === startHandle) {
                        startYear = Math.min(endYear, Math.max(minYear, year));
                    } else {
                        endYear = Math.max(startYear, Math.min(maxYear, year));
                    }
                    
                    updateHandlePositions();
                    applyFilters();
                }
                
                function stopDrag() {
                    activeHandle = null;
                    document.removeEventListener('mousemove', handleDrag);
                    document.removeEventListener('mouseup', stopDrag);
                }
                
                // Initialize slider
                updateHandlePositions();

                // Setup hierarchical law class checkboxes
                const lawClassFilters = document.getElementById('lawClassFilters');
                
                // Get unique law classes and their subtypes
                const lawHierarchy = tableData.reduce((acc, item) => {
                    if (!acc[item.law_class]) {
                        acc[item.law_class] = new Set();
                    }
                    acc[item.law_class].add(item.law_class_subtype);
                    return acc;
                }, {});

                // Convert to sorted array of objects
                const sortedHierarchy = Object.entries(lawHierarchy)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .map(([lawClass, subtypes]) => ({
                        lawClass,
                        subtypes: [...subtypes].sort()
                    }));

                // Generate HTML for hierarchical checkboxes
                lawClassFilters.innerHTML = sortedHierarchy.map(({ lawClass, subtypes }) => `
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" 
                                   class="law-class-checkbox"
                                   data-law-class="${lawClass}" 
                                   checked>
                            ${lawClass}
                            <span class="law-class-toggle"></span>
                        </label>
                        <div class="checkbox-subgroup">
                            ${subtypes.map(subtype => `
                                <div class="checkbox-item">
                                    <label>
                                        <input type="checkbox"
                                               class="law-subtype-checkbox"
                                               data-law-class="${lawClass}"
                                               data-law-subtype="${subtype}"
                                               checked>
                                        ${subtype}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                // Setup hierarchical filtering behavior:
                // 1. Parent (law class) checkboxes control all their subtypes
                // 2. Checking/unchecking a parent affects all its children
                // 3. Child (subtype) checkboxes can be individually toggled
                // 4. Rows are shown if they match ANY selected subtype within their law class
                
                // Add event listeners for parent (law class) checkboxes
                lawClassFilters.querySelectorAll('.law-class-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const lawClass = e.target.dataset.lawClass;
                        // When a parent is toggled, all its children are toggled to match
                        const subtypeCheckboxes = lawClassFilters.querySelectorAll(
                            `.law-subtype-checkbox[data-law-class="${lawClass}"]`
                        );
                        subtypeCheckboxes.forEach(sub => sub.checked = e.target.checked);
                        applyFilters(tableData);
                    });
                });

                // Add event listeners for child (subtype) checkboxes
                // These operate independently, allowing fine-grained control
                lawClassFilters.querySelectorAll('.law-subtype-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => applyFilters(tableData));
                });

                // Add expand/collapse functionality for law class sections
                lawClassFilters.querySelectorAll('.law-class-toggle').forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        e.target.classList.toggle('collapsed');
                        const subgroup = e.target.closest('.checkbox-item').querySelector('.checkbox-subgroup');
                        subgroup.style.display = e.target.classList.contains('collapsed') ? 'none' : 'block';
                    });
                });

                // Setup clear filters button
                document.getElementById('clearFilters').addEventListener('click', clearFilters);

                // Setup download button
                document.getElementById('downloadData').addEventListener('click', downloadData);

                // Setup search input
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', () => {
                    applyFilters();
                });

                // Setup pagination controls
                document.getElementById('entriesPerPage').addEventListener('change', (e) => {
                    rowsPerPage = parseInt(e.target.value);
                    currentPage = 1;
                    renderTable();
                    updatePaginationControls();
                });

                document.getElementById('prevPage').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderTable();
                        updatePaginationControls();
                    }
                });

                document.getElementById('nextPage').addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTable();
                        updatePaginationControls();
                    }
                });

                // Initial pagination setup
                updatePaginationControls();
            }
        }

        // Function to clear all filters
        function clearFilters() {
            startYear = minYear;
            endYear = maxYear;
            updateHandlePositions();
            
            document.querySelectorAll('#lawClassFilters input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            // Clear search input
            document.getElementById('searchInput').value = '';
            
            applyFilters();
        }

        // Function to download filtered data as CSV
        function downloadData() {
            // Get current filtered and sorted data
            const dataToExport = currentSortColumn 
                ? sortData(filteredData, currentSortColumn)
                : filteredData;

            // Prepare CSV data
            const headers = Object.keys(dataToExport[0]);
            const csvRows = [
                // Add headers
                headers.join(','),
                // Add data rows with proper CSV escaping
                ...dataToExport.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Handle different data types and escape special characters
                        if (typeof value === 'string') {
                            // Escape quotes and wrap in quotes if contains special chars
                            const escaped = value.replace(/"/g, '""');
                            return /[,"\n\r]/.test(value) ? `"${escaped}"` : value;
                        }
                        return value;
                    }).join(',')
                )
            ];

            // Create and download the file
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.href = url;
            link.download = `law_database_${timestamp}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Function to apply all filters in sequence
        function applyFilters(data = tableData) {
            // Get current filter values
            const searchTerm = document.getElementById('searchInput').value;
            const selectedFilters = Array.from(
                document.querySelectorAll('#lawClassFilters .law-subtype-checkbox:checked')
            ).map(checkbox => ({
                lawClass: checkbox.dataset.lawClass,
                subtype: checkbox.dataset.lawSubtype
            }));

            // Apply filters in sequence:
            // 1. Year range filter (most restrictive first)
            // 2. Law class/subtype filter (domain-specific filter)
            // 3. Search filter (most flexible last)
            let tempData = [...data];
            tempData = applyYearFilter(tempData, startYear, endYear);
            tempData = applyLawFilter(tempData, selectedFilters);
            tempData = applySearchFilter(tempData, searchTerm);
            
            // Update filtered data
            filteredData = tempData;

            currentPage = 1;
            renderTable();
            updatePaginationControls();
        }

        // Initialize the table
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
